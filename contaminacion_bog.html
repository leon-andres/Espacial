<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jerson Vargas Galeano">
<meta name="author" content="Andres David Leon Hernandez">
<meta name="dcterms.date" content="2026-05-05">

<title>Análisis espacial de la concentración de PM2.5 y PM10 en estaciones de monitoreo de calidad del aire en Bogotá</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="contaminacion_bog_files/libs/clipboard/clipboard.min.js"></script>
<script src="contaminacion_bog_files/libs/quarto-html/quarto.js"></script>
<script src="contaminacion_bog_files/libs/quarto-html/popper.min.js"></script>
<script src="contaminacion_bog_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="contaminacion_bog_files/libs/quarto-html/anchor.min.js"></script>
<link href="contaminacion_bog_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="contaminacion_bog_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="contaminacion_bog_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="contaminacion_bog_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="contaminacion_bog_files/libs/bootstrap/bootstrap-1bc8a17f135ab3d594c857e9f48e611b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Análisis espacial de la concentración de PM2.5 y PM10 en estaciones de monitoreo de calidad del aire en Bogotá</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Jerson Vargas Galeano </p>
             <p>Andres David Leon Hernandez </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 5, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="planteamiento-del-problema" class="level2">
<h2 class="anchored" data-anchor-id="planteamiento-del-problema">Planteamiento del problema</h2>
<p>La contaminación del aire es uno de los principales problemas ambientales que afectan la salud pública, especialmente en las ciudades. En Bogotá, el seguimiento de contaminantes como el PM2.5 y el PM10 se hace por medio de estaciones distribuidas por toda la ciudad. Aun así, todavía hay muchas cosas que no se entienden del todo bien sobre cómo se comportan estos contaminantes en el espacio y el tiempo. Analizar esos patrones puede ser útil para plantear políticas ambientales más efectivas y mejor enfocadas.</p>
</section>
<section id="objetivos" class="level2">
<h2 class="anchored" data-anchor-id="objetivos"><strong>Objetivos</strong></h2>
<section id="objetivo-general" class="level3">
<h3 class="anchored" data-anchor-id="objetivo-general"><strong>Objetivo general</strong></h3>
<p>Analizar la distribución espacio-temporal de los contaminantes PM2.5 y PM10 en Bogotá utilizando los datos provenientes de las estaciones de monitoreo del IDEAM.</p>
</section>
<section id="objetivos-específicos" class="level3">
<h3 class="anchored" data-anchor-id="objetivos-específicos"><strong>Objetivos específicos</strong></h3>
<ul>
<li><p>Observar cómo se distribuyen las concentraciones promedio de PM2.5 y PM10 en diferentes partes del país.</p></li>
<li><p>Identificar zonas con mayores concentraciones y posibles focos de contaminación.</p></li>
<li><p>Examinar cómo la ubicación geográfica podría influir en los niveles de PM2.5 y PM10.</p></li>
</ul>
</section>
</section>
<section id="resultados-esperados" class="level2">
<h2 class="anchored" data-anchor-id="resultados-esperados"><strong>Resultados esperados</strong></h2>
<ul>
<li><p>Mapas temáticos que ilustren la distribución espacial de PM2.5 y PM10 en Colombia.</p></li>
<li><p>Modelos de regresión que nos permitan determinar si existe una relación significativa entre las concentraciones de los contaminantes y su ubicación geográfica.</p></li>
<li><p>Posibles clusters o áreas críticas donde se exceden los límites permisibles.</p></li>
</ul>
</section>
<section id="variables" class="level2">
<h2 class="anchored" data-anchor-id="variables"><strong>Variables</strong></h2>
<section id="variables-de-interés-dependientes" class="level3">
<h3 class="anchored" data-anchor-id="variables-de-interés-dependientes"><strong>Variables de interés (dependientes)</strong></h3>
<ul>
<li><p><strong>PM2.5</strong>: está compuesto por partículas con un diámetro aerodinámico igual o menor a 2.5 micrómetros. Su origen principal es la combustión de vehículos, industrias y quema de biomasa. Contiene sustancias como sulfatos, nitratos, metales pesados y carbono negro. Estas partículas pueden penetrar profundamente en los pulmones y pasar al torrente sanguíneo, provocando enfermedades respiratorias, cardiovasculares e incluso efectos neurológicos. Además, contribuyen a la formación de smog y disminución de visibilidad. Se mide en microgramos por metro cúbico <span class="math inline">\((\mu g/m^3)\)</span>, y la OMS establece límites estrictos por su alta peligrosidad.</p></li>
<li><p><strong>PM10</strong>: incluye todas las partículas con un diámetro igual o menor a 10 micrómetros, por lo que abarca también el PM2.5. Su composición incluye polvo, polen, moho, cenizas y partículas de combustión. Proviene de fuentes naturales (como el polvo del suelo) y antrópicas (construcciones, vehículos). Aunque sus partículas son más grandes, pueden alojarse en las vías respiratorias superiores y causar irritación, tos o crisis asmáticas. También afectan la calidad del aire, deterioran estructuras y ecosistemas. Al igual que el PM2.5, se mide en <span class="math inline">\((\mu g/m^3)\)</span> y es regulado por organismos de salud y medio ambiente**.</p></li>
</ul>
</section>
<section id="variables-explicativas-independientes" class="level3">
<h3 class="anchored" data-anchor-id="variables-explicativas-independientes"><strong>Variables explicativas (independientes)</strong></h3>
<ul>
<li><p><strong>Latitud</strong> y <strong>Longitud</strong> de las estaciones (ubicación geográfica).</p></li>
<li><p><strong>Año</strong> (dimensión temporal).</p></li>
</ul>
</section>
</section>
<section id="análisis-inicial-de-pm2.5" class="level2">
<h2 class="anchored" data-anchor-id="análisis-inicial-de-pm2.5"><strong>Análisis inicial de PM2.5</strong></h2>
<p>El análisis se centrará en un momento específico del tiempo: el año 2022. Para dicho periodo, se dispone de un promedio anual ponderado por estación, correspondiente a las observaciones registradas a lo largo del año. En total, se cuenta con 20 estaciones de monitoreo ubicadas en la ciudad de Bogotá, cada una de las cuales proporciona una observación espacial que representa el valor promedio anual de PM2.5 para su respectiva localización.</p>
<p>Este conjunto de datos permite una primera aproximación descriptiva y espacial del comportamiento del contaminante en la ciudad durante el año de estudio, sirviendo como base para los análisis geoestadísticos posteriores.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Todos los paquetes están instalados. </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    readr     sqldf     tidyr tidyverse   ggplot2 patchwork        sp    fields 
     TRUE      TRUE      TRUE      TRUE      TRUE      TRUE      TRUE      TRUE 
     geoR     akima     shiny     gstat        sf     dplyr     knitr    raster 
     TRUE      TRUE      TRUE      TRUE      TRUE      TRUE      TRUE      TRUE 
   scales 
     TRUE </code></pre>
</div>
</div>
<section id="visualización-espacial-de-las-estaciones-de-monitoreo" class="level3">
<h3 class="anchored" data-anchor-id="visualización-espacial-de-las-estaciones-de-monitoreo">Visualización espacial de las estaciones de monitoreo</h3>
<p>A continuación, se presenta un mapa que muestra la ubicación geográfica de las 20 estaciones de monitoreo de calidad del aire en Bogotá, utilizadas para el análisis del promedio anual de PM2.5 en el año 2022. Cada punto en el mapa representa una estación, y se han incorporado tanto el color como el tamaño del punto para facilitar la interpretación visual.</p>
<p>El color del punto indica el nivel de concentración de PM2.5: una escala de tonalidades que va desde el azul (valores bajos), pasando por el morado (valores intermedios), hasta el rojo (valores altos). Por su parte, el tamaño del punto refleja la cantidad de observaciones registradas durante el año en cada estación: puntos más pequeños corresponden a estaciones con menos datos, mientras que puntos más grandes indican estaciones con una mayor cantidad de mediciones.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `Loca' from data source 
  `C:\Users\User\Documents\GitHub\espacial-2025-1s\Espacial\mapa\Loca.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 20 features and 6 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -74.44978 ymin: 3.73103 xmax: -73.98653 ymax: 4.836779
Geodetic CRS:  MAGNA-SIRGAS</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>En general, se observa que la mayoría de estaciones presentan valores intermedios de PM2.5 (tonos morados) y una buena cantidad de registros, con un total aproximado de 8.000 observaciones en todo el conjunto de datos. No obstante, se destacan algunos casos particulares: una estación ubicada hacia el norte de la ciudad muestra un valor especialmente bajo de PM2.5 (color azul), mientras que otra estación presenta un valor excepcionalmente alto (color rojo), aunque con pocas observaciones disponibles.</p>
<p>Es importante señalar que algunas zonas del mapa aparecen sin estaciones de monitoreo, ya que estas corresponden a localidades donde no se realizaron mediciones, motivo por el cual dichas áreas no cuentan con datos representados en esta visualización.</p>
</section>
<section id="exploración-de-la-relación-entre-pm2.5-y-las-coordenadas-espaciales" class="level3">
<h3 class="anchored" data-anchor-id="exploración-de-la-relación-entre-pm2.5-y-las-coordenadas-espaciales">Exploración de la relación entre PM2.5 y las coordenadas espaciales</h3>
<p>Con el fin de explorar la posible influencia de la ubicación geográfica sobre los niveles de PM2.5, se realizaron gráficos de dispersión que muestran el comportamiento de esta variable en función de las coordenadas espaciales: Este (X) y Norte (Y). Ambos gráficos se presentan de manera conjunta, con la relación PM2.5 vs Este a la izquierda y PM2.5 vs Norte a la derecha, lo que permite una comparación visual directa.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>En el gráfico correspondiente a la coordenada Este, se observa una posible tendencia decreciente de tipo lineal: a medida que aumenta la coordenada este, los valores de PM2.5 tienden a disminuir. Esto sugiere la existencia de un patrón espacial en dirección este-oeste. Por otro lado, el gráfico que relaciona PM2.5 con la coordenada Norte no muestra una tendencia clara ni un comportamiento sistemático, lo que indicaría una menor influencia de esta dimensión espacial sobre la variabilidad del contaminante.</p>
<p>Además, en ambos gráficos se identifican posibles valores atípicos, representados por dos observaciones con niveles notablemente altos de PM2.5. Estos puntos podrían influir en el ajuste de modelos posteriores y deben ser tenidos en cuenta en el análisis.</p>
<p>En conjunto, estos resultados preliminares sugieren que podría ser apropiado considerar un modelo lineal simple que incorpore únicamente la coordenada Este para capturar la tendencia espacial de los datos, al menos en una primera aproximación.</p>
<section id="análisis-de-correlación-entre-pm2.5-y-las-coordenadas-espaciales" class="level4">
<h4 class="anchored" data-anchor-id="análisis-de-correlación-entre-pm2.5-y-las-coordenadas-espaciales">Análisis de correlación entre PM2.5 y las coordenadas espaciales</h4>
<p>Con el objetivo de respaldar cuantitativamente las observaciones realizadas en los gráficos anteriores, se procedió a calcular la matriz de correlación entre las variables PM2.5, Este y Norte. Aunque la relación entre las coordenadas Este y Norte no es de interés en este contexto, nos enfocamos particularmente en las correlaciones de PM2.5 con cada una de las coordenadas espaciales por separado.</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Matriz de Correlación</caption>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">este</th>
<th style="text-align: right;">norte</th>
<th style="text-align: right;">PM2.5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">este</td>
<td style="text-align: right;">1.0000000</td>
<td style="text-align: right;">0.4969499</td>
<td style="text-align: right;">-0.7274989</td>
</tr>
<tr class="even">
<td style="text-align: left;">norte</td>
<td style="text-align: right;">0.4969499</td>
<td style="text-align: right;">1.0000000</td>
<td style="text-align: right;">-0.4557684</td>
</tr>
<tr class="odd">
<td style="text-align: left;">PM2.5</td>
<td style="text-align: right;">-0.7274989</td>
<td style="text-align: right;">-0.4557684</td>
<td style="text-align: right;">1.0000000</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Los resultados muestran que la correlación entre PM2.5 y la coordenada Este es de aproximadamente -0.67, lo que indica una fuerte relación inversa: a medida que se avanza hacia el este de la ciudad, los valores de PM2.5 tienden a disminuir. Por su parte, la correlación entre PM2.5 y la coordenada Norte es más débil, con un valor cercano a -0.43, lo cual sugiere una tendencia decreciente más tenue o posiblemente poco significativa.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Estos resultados se visualizan mediante un mapa de calor de la matriz de correlaciones, donde se utiliza una escala de color que va desde el azul oscuro (para relaciones negativas fuertes) hasta el rojo oscuro (para relaciones positivas fuertes). En el gráfico, se aprecia claramente que la celda correspondiente a la relación entre PM2.5 y la coordenada Este se tiñe de azul oscuro, lo cual refuerza la interpretación de una asociación negativa importante. En cambio, la celda que representa la correlación con la coordenada Norte presenta un tono azul más claro, reflejando una relación más débil.</p>
</section>
</section>
<section id="ajuste-del-modelo-de-tendencia-mediante-regresión-ponderada" class="level3">
<h3 class="anchored" data-anchor-id="ajuste-del-modelo-de-tendencia-mediante-regresión-ponderada">Ajuste del modelo de tendencia mediante regresión ponderada</h3>
<p>Con base en la evidencia obtenida a partir de los gráficos de dispersión y el análisis de correlación, se procedió a ajustar un modelo de regresión lineal ponderado con el fin de extraer la tendencia espacial del contaminante PM2.5. En este caso, se utilizaron como ponderaciones el total de observaciones realizadas en cada estación de monitoreo, dado que los valores de PM2.5 corresponden a promedios ponderados, y por lo tanto, las estaciones con mayor cantidad de datos tienen mayor peso en el análisis.</p>
<p>Durante el proceso de modelado se exploraron diversas especificaciones, incluyendo modelos con términos cuadráticos, interacciones y combinaciones de ambas coordenadas. Sin embargo, tras evaluar el desempeño de cada uno, se determinó que el modelo más adecuado —en términos de simplicidad, significancia estadística y comportamiento de los residuos— fue aquel que incluye únicamente la coordenada Este como variable explicativa:</p>
<p><span class="math display">\[PM 2.5 = \beta_0 +β_1⋅Este + \epsilon\]</span></p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = PM2.5 ~ este + I(este^2), data = PM2_5, weights = TotDat)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-64.932 -17.420  -1.838  20.822 129.736 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)  1.327e+04  1.166e+04   1.138    0.272
este        -4.359e-02  3.890e-02  -1.121    0.279
I(este^2)    3.583e-08  3.244e-08   1.105    0.286

Residual standard error: 47.22 on 16 degrees of freedom
Multiple R-squared:  0.567, Adjusted R-squared:  0.5128 
F-statistic: 10.47 on 2 and 16 DF,  p-value: 0.001236</code></pre>
</div>
</div>
<p>Los resultados del modelo estimado son los siguientes:</p>
<ul>
<li>Intercepto: <span class="math inline">\(\hat{\beta_0}=412.6\)</span>, con un valor p = 0.0004</li>
<li>Pendiente: <span class="math inline">\(\hat{\beta_1}=−0.0006596\)</span>, con un valor p = 0.0005</li>
</ul>
<p>Ambos coeficientes son estadísticamente significativos al 1%. La pendiente negativa confirma la tendencia decreciente de PM2.5 en dirección Este, como se había sugerido previamente. El coeficiente de determinación ajustado (<span class="math inline">\(R^2\)</span> ajustado) fue de 0.467, lo cual indica que aproximadamente un 47% de la variabilidad en los niveles de PM2.5 puede ser explicada por la ubicación este de las estaciones.</p>
<p>Este modelo será utilizado para eliminar la tendencia y permitir un análisis más preciso de la estructura espacial residual en los pasos posteriores.</p>
</section>
<section id="análisis-gráfico-de-los-residuos-estandarizados" class="level3">
<h3 class="anchored" data-anchor-id="análisis-gráfico-de-los-residuos-estandarizados">Análisis gráfico de los residuos estandarizados</h3>
<p>Una vez ajustado el modelo de tendencia, se procedió a evaluar el comportamiento de los residuos estandarizados con el fin de identificar posibles patrones espaciales residuales o la presencia de datos atípicos. Para ello, se realizaron gráficos de dispersión de los residuos estandarizados tanto frente a la coordenada Este como a la coordenada Norte, así como un diagrama de caja (boxplot).</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>En ambos gráficos de dispersión se observó un comportamiento razonablemente aleatorio, lo que sugiere que la tendencia ha sido correctamente eliminada. No obstante, en ambos casos se evidencian dos posibles datos atípicos por su magnitud. Esta observación se refuerza con el boxplot, el cual identifica al menos un valor extremo, consistente con lo visto en los otros gráficos.</p>
<p>Aunque se utilizaron residuos estandarizados para facilitar la visualización y comparación, el análisis posterior se realizará con los residuos originales, ya que estos conservan la estructura espacial y magnitud real del error en la variable de interés.</p>
<p>A pesar de la presencia de estos puntos atípicos, no se optó por eliminarlos, ya que forman parte del fenómeno real observado. En su lugar, se utilizarán posteriormente estimadores robustos del semivariograma, los cuales son menos sensibles a la presencia de valores extremos y permiten un análisis geoestadístico confiable sin distorsión significativa por dichos puntos.</p>
<section id="visualización-espacial-y-distribución-de-los-residuos" class="level4">
<h4 class="anchored" data-anchor-id="visualización-espacial-y-distribución-de-los-residuos">Visualización espacial y distribución de los residuos</h4>
<p>Para complementar el análisis de los residuos, se realizó una exploración gráfica empleando funciones del paquete geoestadístico que permiten visualizar la distribución de los residuos en el espacio, así como su comportamiento multivariado.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-10-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Se generaron tres tipos principales de gráficos de interés:</p>
<ul>
<li><p><strong>Gráfico de cuantiles espaciales</strong>: Este gráfico muestra la ubicación de los residuos en el plano espacial (coordenadas Este y Norte), codificados por colores según sus cuantiles. La mezcla de colores indica que los residuos están distribuidos espacialmente sin un patrón sistemático ni agrupamientos claros, lo que confirma que la tendencia principal fue efectivamente eliminada en el ajuste del modelo.</p></li>
<li><p><strong>Gráficos de densidad</strong>: Este gráfico permite visualizar que la mayor concentración de residuos está cerca de valores bajos, reforzando la idea de que los residuos están centrados alrededor de cero y que no existe una fuerte dependencia espacial no explicada.</p></li>
</ul>
<p><strong>Gráfico tridimensionales</strong>: Este gráfico permite observar la distribución de los residuos considerando simultáneamente las coordenadas Este, Norte y el valor del residuo (eje vertical). En estos gráficos se confirma que la mayoría de los residuos se concentran en valores bajos, con pocos valores altos dispersos, lo que corresponde con los datos atípicos detectados anteriormente.</p>
<p>En conjunto, estas visualizaciones apoyan la validez del modelo ajustado y justifican avanzar al análisis geoestadístico mediante la estimación del semivariograma, considerando que los residuos representan el componente espacial de interés.</p>
</section>
</section>
<section id="estimación-del-semivariograma-y-uso-de-un-estimador-robusto" class="level3">
<h3 class="anchored" data-anchor-id="estimación-del-semivariograma-y-uso-de-un-estimador-robusto">Estimación del semivariograma y uso de un estimador robusto</h3>
<p>En esta sección se procede a estimar el semivariograma empírico de los residuos estandarizados obtenidos del modelo de regresión ponderada previamente ajustado. Esta estimación tiene como objetivo analizar la dependencia espacial de los residuos, lo cual es esencial antes de aplicar cualquier modelo geoestadístico. Dado que los residuos presentaban valores atípicos, se plantea el uso de un estimador robusto del semivariograma, en lugar del estimador clásico.</p>
<section id="semivariograma-clásico" class="level4">
<h4 class="anchored" data-anchor-id="semivariograma-clásico">Semivariograma clásico</h4>
<p>Como primer paso, se calculó el semivariograma empírico utilizando el estimador clásico definido como:</p>
<p><span class="math display">\[
\hat{\gamma}(h) = \frac{1}{2N(h)} \sum_{i=1}^{N(h)} \left[ Z(s_i + h) - Z(s_i) \right]^2
\]</span> donde N(h) representa el número de pares de puntos separados por una distancia aproximadamente igual a h, y Z(s) representa el valor del proceso en la ubicación s.</p>
<p>Para garantizar la fiabilidad estadística de las estimaciones, se consideraron únicamente aquellos rezagos h donde se cumpliera que N(h)&gt;6. Esto se hace para asegurar que el número de pares sea suficiente para obtener un promedio representativo en cada distancia, evitando valores extremadamente inestables o influenciados por unos pocos datos, lo cual es especialmente importante en rezagos donde los datos están dispersos o hay menor cobertura espacial.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>variog: computing omnidirectional variogram</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>El semivariograma estimado con este método mostró un valor atípicamente alto en el segundo rezago, lo cual ya sugería la posible influencia de valores extremos en la estimación. Para examinar esta situación, se construyeron boxplots para las diferencias al cuadrado espaciales en cada uno de los 10 rezagos. Los boxplots revelaron la presencia sistemática de valores atípicos en múltiples distancias, confirmando que el uso del estimador clásico podía estar sesgado.</p>
</section>
</section>
<section id="ajuste-de-modelos-teóricos-al-semivariograma-empírico" class="level3">
<h3 class="anchored" data-anchor-id="ajuste-de-modelos-teóricos-al-semivariograma-empírico">Ajuste de modelos teóricos al semivariograma empírico</h3>
<p>Después de estimar el semivariograma empírico usando el estimador robusto basado en la mediana, se procedió a ajustar distintos modelos teóricos con el fin de representar adecuadamente la dependencia espacial presente en los datos.</p>
<p>Para este proceso se utilizó primero una herramienta llamada eyefit, que permite hacer un ajuste visual inicial de diferentes modelos teóricos al semivariograma empírico. Con esta función interactiva se fue probando distintas combinaciones de parámetros, tanto para modelos del tipo Wave como exponencial, observando visualmente cuáles se aproximaban mejor a la forma del semivariograma. Con base en esto, se seleccionó tres modelos que mostraban un comportamiento razonable frente a los datos empíricos: dos modelos Wave (uno con pepita fija y otro con pepita libre), y un modelo exponencial con pepita libre.</p>
<p>Los valores iniciales de los parámetros para cada modelo se tomaron de ese ajuste visual. Luego, con esos valores, se hizo el ajuste formal mediante una función que permite optimizar los parámetros para que el modelo se adapte lo mejor posible al semivariograma empírico, en este caso ponderando según el número de pares de observaciones en cada rezago. Para uno de los modelos Wave se dejó la pepita fija en 1.72; mientras que en los otros dos modelos se permitió que la pepita se ajustara libremente.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>variofit: covariance model used is wave 
variofit: weights used: npairs 
variofit: minimisation function used: optim </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>variofit: covariance model used is spherical 
variofit: weights used: npairs 
variofit: minimisation function used: optim </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>variofit: covariance model used is gaussian 
variofit: weights used: npairs 
variofit: minimisation function used: optim </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>variofit: covariance model used is exponential 
variofit: weights used: npairs 
variofit: minimisation function used: optim </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>variofit: covariance model used is matern 
variofit: weights used: npairs 
variofit: minimisation function used: optim </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Una vez realizados los ajustes, se graficaron los tres modelos teóricos junto al semivariograma empírico. Visualmente, los tres modelos parecen representar adecuadamente la estructura espacial de los datos. Todos capturan bien el incremento inicial de la semivarianza. Sin embargo, para decidir cuál de los modelos se ajusta mejor, se utilizará el criterio cuantitativo basado en el error cuadrático medio (RMSE), que permitirá comparar qué tan cerca está cada modelo de los valores empíricos en promedio.</p>
<p>Los resultados obtenidos para el RMSE de cada modelo fueron los siguientes:</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Modelo</th>
<th style="text-align: right;">RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Wave</td>
<td style="text-align: right;">1.673740</td>
</tr>
<tr class="even">
<td style="text-align: left;">Espherical</td>
<td style="text-align: right;">1.376316</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Gaussian</td>
<td style="text-align: right;">1.393758</td>
</tr>
<tr class="even">
<td style="text-align: left;">Exponential</td>
<td style="text-align: right;">1.296813</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Matern</td>
<td style="text-align: right;">1.355531</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>A partir de estos valores, se observa que el modelo Wave con pepita fija presenta el menor RMSE, lo que indica que es el que mejor se ajusta al semivariograma empírico bajo este criterio. Aunque las diferencias no son tan grandes respecto al modelo Wave con pepita libre, sí marcan una ventaja que justifica seleccionarlo como el modelo final a utilizar en adelante para la representación de la estructura de dependencia espacial en los datos.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Warning in kriging_sd_masked/PM25_estimado_masked: Raster objects have
different extents. Result for their intersection is returned</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="pm10" class="level1">
<h1>PM10</h1>
<section id="visualización-espacial-de-las-estaciones-de-monitoreo-1" class="level3">
<h3 class="anchored" data-anchor-id="visualización-espacial-de-las-estaciones-de-monitoreo-1">Visualización espacial de las estaciones de monitoreo</h3>
<p>A continuación, se presenta un mapa que muestra la ubicación geográfica de las 20 estaciones de monitoreo de calidad del aire en Bogotá, utilizadas para el análisis del promedio anual de PM2.5 en el año 2022. Cada punto en el mapa representa una estación, y se han incorporado tanto el color como el tamaño del punto para facilitar la interpretación visual.</p>
<p>El color del punto indica el nivel de concentración de PM2.5: una escala de tonalidades que va desde el azul (valores bajos), pasando por el morado (valores intermedios), hasta el rojo (valores altos). Por su parte, el tamaño del punto refleja la cantidad de observaciones registradas durante el año en cada estación: puntos más pequeños corresponden a estaciones con menos datos, mientras que puntos más grandes indican estaciones con una mayor cantidad de mediciones.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>En general, se observa que la mayoría de estaciones presentan valores intermedios de PM2.5 (tonos morados) y una buena cantidad de registros, con un total aproximado de 8.000 observaciones en todo el conjunto de datos. No obstante, se destacan algunos casos particulares: una estación ubicada hacia el norte de la ciudad muestra un valor especialmente bajo de PM2.5 (color azul), mientras que otra estación presenta un valor excepcionalmente alto (color rojo), aunque con pocas observaciones disponibles.</p>
<p>Es importante señalar que algunas zonas del mapa aparecen sin estaciones de monitoreo, ya que estas corresponden a localidades donde no se realizaron mediciones, motivo por el cual dichas áreas no cuentan con datos representados en esta visualización.</p>
</section>
<section id="exploración-de-la-relación-entre-pm2.5-y-las-coordenadas-espaciales-1" class="level3">
<h3 class="anchored" data-anchor-id="exploración-de-la-relación-entre-pm2.5-y-las-coordenadas-espaciales-1">Exploración de la relación entre PM2.5 y las coordenadas espaciales</h3>
<p>Con el fin de explorar la posible influencia de la ubicación geográfica sobre los niveles de PM2.5, se realizaron gráficos de dispersión que muestran el comportamiento de esta variable en función de las coordenadas espaciales: Este (X) y Norte (Y). Ambos gráficos se presentan de manera conjunta, con la relación PM2.5 vs Este a la izquierda y PM2.5 vs Norte a la derecha, lo que permite una comparación visual directa.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>En el gráfico correspondiente a la coordenada Este, se observa una posible tendencia decreciente de tipo lineal: a medida que aumenta la coordenada este, los valores de PM2.5 tienden a disminuir. Esto sugiere la existencia de un patrón espacial en dirección este-oeste. Por otro lado, el gráfico que relaciona PM2.5 con la coordenada Norte no muestra una tendencia clara ni un comportamiento sistemático, lo que indicaría una menor influencia de esta dimensión espacial sobre la variabilidad del contaminante.</p>
<p>Además, en ambos gráficos se identifican posibles valores atípicos, representados por dos observaciones con niveles notablemente altos de PM2.5. Estos puntos podrían influir en el ajuste de modelos posteriores y deben ser tenidos en cuenta en el análisis.</p>
<p>En conjunto, estos resultados preliminares sugieren que podría ser apropiado considerar un modelo lineal simple que incorpore únicamente la coordenada Este para capturar la tendencia espacial de los datos, al menos en una primera aproximación.</p>
<section id="análisis-de-correlación-entre-pm2.5-y-las-coordenadas-espaciales-1" class="level4">
<h4 class="anchored" data-anchor-id="análisis-de-correlación-entre-pm2.5-y-las-coordenadas-espaciales-1">Análisis de correlación entre PM2.5 y las coordenadas espaciales</h4>
<p>Con el objetivo de respaldar cuantitativamente las observaciones realizadas en los gráficos anteriores, se procedió a calcular la matriz de correlación entre las variables PM2.5, Este y Norte. Aunque la relación entre las coordenadas Este y Norte no es de interés en este contexto, nos enfocamos particularmente en las correlaciones de PM2.5 con cada una de las coordenadas espaciales por separado.</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Matriz de Correlación</caption>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">este</th>
<th style="text-align: right;">norte</th>
<th style="text-align: right;">PM10</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">este</td>
<td style="text-align: right;">1.0000000</td>
<td style="text-align: right;">0.4554527</td>
<td style="text-align: right;">-0.8531711</td>
</tr>
<tr class="even">
<td style="text-align: left;">norte</td>
<td style="text-align: right;">0.4554527</td>
<td style="text-align: right;">1.0000000</td>
<td style="text-align: right;">-0.3028284</td>
</tr>
<tr class="odd">
<td style="text-align: left;">PM10</td>
<td style="text-align: right;">-0.8531711</td>
<td style="text-align: right;">-0.3028284</td>
<td style="text-align: right;">1.0000000</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Los resultados muestran que la correlación entre PM2.5 y la coordenada Este es de aproximadamente -0.67, lo que indica una fuerte relación inversa: a medida que se avanza hacia el este de la ciudad, los valores de PM2.5 tienden a disminuir. Por su parte, la correlación entre PM2.5 y la coordenada Norte es más débil, con un valor cercano a -0.43, lo cual sugiere una tendencia decreciente más tenue o posiblemente poco significativa.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Estos resultados se visualizan mediante un mapa de calor de la matriz de correlaciones, donde se utiliza una escala de color que va desde el azul oscuro (para relaciones negativas fuertes) hasta el rojo oscuro (para relaciones positivas fuertes). En el gráfico, se aprecia claramente que la celda correspondiente a la relación entre PM2.5 y la coordenada Este se tiñe de azul oscuro, lo cual refuerza la interpretación de una asociación negativa importante. En cambio, la celda que representa la correlación con la coordenada Norte presenta un tono azul más claro, reflejando una relación más débil.</p>
</section>
</section>
<section id="ajuste-del-modelo-de-tendencia-mediante-regresión-ponderada-1" class="level3">
<h3 class="anchored" data-anchor-id="ajuste-del-modelo-de-tendencia-mediante-regresión-ponderada-1">Ajuste del modelo de tendencia mediante regresión ponderada</h3>
<p>Con base en la evidencia obtenida a partir de los gráficos de dispersión y el análisis de correlación, se procedió a ajustar un modelo de regresión lineal ponderado con el fin de extraer la tendencia espacial del contaminante PM2.5. En este caso, se utilizaron como ponderaciones el total de observaciones realizadas en cada estación de monitoreo, dado que los valores de PM2.5 corresponden a promedios ponderados, y por lo tanto, las estaciones con mayor cantidad de datos tienen mayor peso en el análisis.</p>
<p>Durante el proceso de modelado se exploraron diversas especificaciones, incluyendo modelos con términos cuadráticos, interacciones y combinaciones de ambas coordenadas. Sin embargo, tras evaluar el desempeño de cada uno, se determinó que el modelo más adecuado —en términos de simplicidad, significancia estadística y comportamiento de los residuos— fue aquel que incluye únicamente la coordenada Este como variable explicativa:</p>
<p><span class="math display">\[PM 2.5 = \beta_0 +β_1⋅Este + \epsilon\]</span></p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = PM10 ~ este + I(este^2), data = PM10, weights = TotDat)

Weighted Residuals:
    Min      1Q  Median      3Q     Max 
-118.77  -45.36  -27.83   59.54  211.82 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)  2.837e+04  2.172e+04   1.307    0.211
este        -9.271e-02  7.244e-02  -1.280    0.220
I(este^2)    7.579e-08  6.040e-08   1.255    0.229

Residual standard error: 87.36 on 15 degrees of freedom
Multiple R-squared:  0.7639,    Adjusted R-squared:  0.7325 
F-statistic: 24.27 on 2 and 15 DF,  p-value: 1.985e-05</code></pre>
</div>
</div>
<p>Los resultados del modelo estimado son los siguientes:</p>
<ul>
<li>Intercepto: <span class="math inline">\(\hat{\beta_0}=412.6\)</span>, con un valor p = 0.0004</li>
<li>Pendiente: <span class="math inline">\(\hat{\beta_1}=−0.0006596\)</span>, con un valor p = 0.0005</li>
</ul>
<p>Ambos coeficientes son estadísticamente significativos al 1%. La pendiente negativa confirma la tendencia decreciente de PM2.5 en dirección Este, como se había sugerido previamente. El coeficiente de determinación ajustado (<span class="math inline">\(R^2\)</span> ajustado) fue de 0.467, lo cual indica que aproximadamente un 47% de la variabilidad en los niveles de PM2.5 puede ser explicada por la ubicación este de las estaciones.</p>
<p>Este modelo será utilizado para eliminar la tendencia y permitir un análisis más preciso de la estructura espacial residual en los pasos posteriores.</p>
</section>
<section id="análisis-gráfico-de-los-residuos-estandarizados-1" class="level3">
<h3 class="anchored" data-anchor-id="análisis-gráfico-de-los-residuos-estandarizados-1">Análisis gráfico de los residuos estandarizados</h3>
<p>Una vez ajustado el modelo de tendencia, se procedió a evaluar el comportamiento de los residuos estandarizados con el fin de identificar posibles patrones espaciales residuales o la presencia de datos atípicos. Para ello, se realizaron gráficos de dispersión de los residuos estandarizados tanto frente a la coordenada Este como a la coordenada Norte, así como un diagrama de caja (boxplot).</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>En ambos gráficos de dispersión se observó un comportamiento razonablemente aleatorio, lo que sugiere que la tendencia ha sido correctamente eliminada. No obstante, en ambos casos se evidencian dos posibles datos atípicos por su magnitud. Esta observación se refuerza con el boxplot, el cual identifica al menos un valor extremo, consistente con lo visto en los otros gráficos.</p>
<p>Aunque se utilizaron residuos estandarizados para facilitar la visualización y comparación, el análisis posterior se realizará con los residuos originales, ya que estos conservan la estructura espacial y magnitud real del error en la variable de interés.</p>
<p>A pesar de la presencia de estos puntos atípicos, no se optó por eliminarlos, ya que forman parte del fenómeno real observado. En su lugar, se utilizarán posteriormente estimadores robustos del semivariograma, los cuales son menos sensibles a la presencia de valores extremos y permiten un análisis geoestadístico confiable sin distorsión significativa por dichos puntos.</p>
<section id="visualización-espacial-y-distribución-de-los-residuos-1" class="level4">
<h4 class="anchored" data-anchor-id="visualización-espacial-y-distribución-de-los-residuos-1">Visualización espacial y distribución de los residuos</h4>
<p>Para complementar el análisis de los residuos, se realizó una exploración gráfica empleando funciones del paquete geoestadístico que permiten visualizar la distribución de los residuos en el espacio, así como su comportamiento multivariado.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-27-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Se generaron tres tipos principales de gráficos de interés:</p>
<ul>
<li><p><strong>Gráfico de cuantiles espaciales</strong>: Este gráfico muestra la ubicación de los residuos en el plano espacial (coordenadas Este y Norte), codificados por colores según sus cuantiles. La mezcla de colores indica que los residuos están distribuidos espacialmente sin un patrón sistemático ni agrupamientos claros, lo que confirma que la tendencia principal fue efectivamente eliminada en el ajuste del modelo.</p></li>
<li><p><strong>Gráficos de densidad</strong>: Este gráfico permite visualizar que la mayor concentración de residuos está cerca de valores bajos, reforzando la idea de que los residuos están centrados alrededor de cero y que no existe una fuerte dependencia espacial no explicada.</p></li>
</ul>
<p><strong>Gráfico tridimensionales</strong>: Este gráfico permite observar la distribución de los residuos considerando simultáneamente las coordenadas Este, Norte y el valor del residuo (eje vertical). En estos gráficos se confirma que la mayoría de los residuos se concentran en valores bajos, con pocos valores altos dispersos, lo que corresponde con los datos atípicos detectados anteriormente.</p>
<p>En conjunto, estas visualizaciones apoyan la validez del modelo ajustado y justifican avanzar al análisis geoestadístico mediante la estimación del semivariograma, considerando que los residuos representan el componente espacial de interés.</p>
</section>
</section>
<section id="estimación-del-semivariograma-y-uso-de-un-estimador-robusto-1" class="level3">
<h3 class="anchored" data-anchor-id="estimación-del-semivariograma-y-uso-de-un-estimador-robusto-1">Estimación del semivariograma y uso de un estimador robusto</h3>
<p>En esta sección se procede a estimar el semivariograma empírico de los residuos estandarizados obtenidos del modelo de regresión ponderada previamente ajustado. Esta estimación tiene como objetivo analizar la dependencia espacial de los residuos, lo cual es esencial antes de aplicar cualquier modelo geoestadístico. Dado que los residuos presentaban valores atípicos, se plantea el uso de un estimador robusto del semivariograma, en lugar del estimador clásico.</p>
<section id="semivariograma-clásico-1" class="level4">
<h4 class="anchored" data-anchor-id="semivariograma-clásico-1">Semivariograma clásico</h4>
<p>Como primer paso, se calculó el semivariograma empírico utilizando el estimador clásico definido como:</p>
<p><span class="math display">\[
\hat{\gamma}(h) = \frac{1}{2N(h)} \sum_{i=1}^{N(h)} \left[ Z(s_i + h) - Z(s_i) \right]^2
\]</span></p>
<p>donde N(h) representa el número de pares de puntos separados por una distancia aproximadamente igual a h, y Z(s) representa el valor del proceso en la ubicación s.</p>
<p>Para garantizar la fiabilidad estadística de las estimaciones, se consideraron únicamente aquellos rezagos h donde se cumpliera que N(h)&gt;6. Esto se hace para asegurar que el número de pares sea suficiente para obtener un promedio representativo en cada distancia, evitando valores extremadamente inestables o influenciados por unos pocos datos, lo cual es especialmente importante en rezagos donde los datos están dispersos o hay menor cobertura espacial.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>variog: computing omnidirectional variogram</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>El semivariograma estimado con este método mostró un valor atípicamente alto en el segundo rezago, lo cual ya sugería la posible influencia de valores extremos en la estimación. Para examinar esta situación, se construyeron boxplots para las diferencias al cuadrado espaciales en cada uno de los 10 rezagos. Los boxplots revelaron la presencia sistemática de valores atípicos en múltiples distancias, confirmando que el uso del estimador clásico podía estar sesgado.</p>
</section>
</section>
<section id="ajuste-de-modelos-teóricos-al-semivariograma-empírico-1" class="level3">
<h3 class="anchored" data-anchor-id="ajuste-de-modelos-teóricos-al-semivariograma-empírico-1">Ajuste de modelos teóricos al semivariograma empírico</h3>
<p>Después de estimar el semivariograma empírico usando el estimador robusto basado en la mediana, se procedió a ajustar distintos modelos teóricos con el fin de representar adecuadamente la dependencia espacial presente en los datos.</p>
<p>Para este proceso se utilizó primero una herramienta llamada eyefit, que permite hacer un ajuste visual inicial de diferentes modelos teóricos al semivariograma empírico. Con esta función interactiva se fue probando distintas combinaciones de parámetros, tanto para modelos del tipo Wave como exponencial, observando visualmente cuáles se aproximaban mejor a la forma del semivariograma. Con base en esto, se seleccionó tres modelos que mostraban un comportamiento razonable frente a los datos empíricos: dos modelos Wave (uno con pepita fija y otro con pepita libre), y un modelo exponencial con pepita libre.</p>
<p>Los valores iniciales de los parámetros para cada modelo se tomaron de ese ajuste visual. Luego, con esos valores, se hizo el ajuste formal mediante una función que permite optimizar los parámetros para que el modelo se adapte lo mejor posible al semivariograma empírico, en este caso ponderando según el número de pares de observaciones en cada rezago. Para uno de los modelos Wave se dejó la pepita fija en 1.72; mientras que en los otros dos modelos se permitió que la pepita se ajustara libremente.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>variofit: covariance model used is wave 
variofit: weights used: npairs 
variofit: minimisation function used: optim </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>variofit: covariance model used is spherical 
variofit: weights used: npairs 
variofit: minimisation function used: optim </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>variofit: covariance model used is gaussian 
variofit: weights used: npairs 
variofit: minimisation function used: optim </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>variofit: covariance model used is exponential 
variofit: weights used: npairs 
variofit: minimisation function used: optim </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>variofit: covariance model used is matern 
variofit: weights used: npairs 
variofit: minimisation function used: optim </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Una vez realizados los ajustes, se graficaron los tres modelos teóricos junto al semivariograma empírico. Visualmente, los tres modelos parecen representar adecuadamente la estructura espacial de los datos. Todos capturan bien el incremento inicial de la semivarianza. Sin embargo, para decidir cuál de los modelos se ajusta mejor, se utilizará el criterio cuantitativo basado en el error cuadrático medio (RMSE), que permitirá comparar qué tan cerca está cada modelo de los valores empíricos en promedio.</p>
<p>Los resultados obtenidos para el RMSE de cada modelo fueron los siguientes:</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Modelo</th>
<th style="text-align: right;">RMSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Wave</td>
<td style="text-align: right;">4.772545</td>
</tr>
<tr class="even">
<td style="text-align: left;">Espherical</td>
<td style="text-align: right;">4.596062</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Gaussian</td>
<td style="text-align: right;">4.596040</td>
</tr>
<tr class="even">
<td style="text-align: left;">Exponential</td>
<td style="text-align: right;">4.596035</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Matern</td>
<td style="text-align: right;">4.596058</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>A partir de estos valores, se observa que el modelo Wave con pepita fija presenta el menor RMSE, lo que indica que es el que mejor se ajusta al semivariograma empírico bajo este criterio. Aunque las diferencias no son tan grandes respecto al modelo Wave con pepita libre, sí marcan una ventaja que justifica seleccionarlo como el modelo final a utilizar en adelante para la representación de la estructura de dependencia espacial en los datos.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Warning in kriging_sd_masked/PM10_estimado_masked: Raster objects have
different extents. Result for their intersection is returned</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="cokriging" class="level1">
<h1>COKRIGING</h1>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>            este     norte     PM2.5       PM10
este  1.00000000 0.4554527 0.2378597 0.03192831
norte 0.45545268 1.0000000 0.1406517 0.13592890
PM2.5 0.23785969 0.1406517 1.0000000 0.61331033
PM10  0.03192831 0.1359289 0.6133103 1.00000000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   1293    6939   10605   11687   15352   30065 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Object of class SpatialPointsDataFrame
Coordinates:
           min      max
este  592481.6 607533.4
norte 500791.5 528834.8
Is projected: NA 
proj4string : [NA]
Number of points: 19
Data attributes:
     PM2.5               PM10         
 Min.   :-3.48070   Min.   :-6.40381  
 1st Qu.:-0.91895   1st Qu.:-2.74886  
 Median :-0.10646   Median :-1.49898  
 Mean   : 0.06846   Mean   :-0.02899  
 3rd Qu.: 1.10450   3rd Qu.: 3.23343  
 Max.   : 6.97464   Max.   :11.19492  
                    NA's   :1         </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>    Modelo      RMSE
12 Gau9000  5.365889
11 Gau8000  5.412357
10 Gau7000  5.566375
9  Gau6000  5.921648
4  Exp9000  6.173449
3  Exp8000  6.328520
2  Exp7000  6.552319
1  Exp6000  6.897060
8  Sph9000  8.299080
7  Sph8000 10.008588
6  Sph7000 13.385435
5  Sph6000 20.649943</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Linear Model of Coregionalization found. Good.
[using ordinary cokriging]</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-40-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.6285  0.7689  1.4085  2.7339  4.7267  6.9740 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-40-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cokriging-pm10" class="level1">
<h1>COKRIGING PM10</h1>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>            este     norte     PM2.5       PM10
este  1.00000000 0.4554527 0.2378597 0.03192831
norte 0.45545268 1.0000000 0.1406517 0.13592890
PM2.5 0.23785969 0.1406517 1.0000000 0.61331033
PM10  0.03192831 0.1359289 0.6133103 1.00000000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   1293    6939   10605   11687   15352   30065 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Object of class SpatialPointsDataFrame
Coordinates:
           min      max
este  592481.6 607533.4
norte 500791.5 528834.8
Is projected: NA 
proj4string : [NA]
Number of points: 19
Data attributes:
     PM2.5               PM10         
 Min.   :-3.48070   Min.   :-6.40381  
 1st Qu.:-0.91895   1st Qu.:-2.74886  
 Median :-0.10646   Median :-1.49898  
 Mean   : 0.06846   Mean   :-0.02899  
 3rd Qu.: 1.10450   3rd Qu.: 3.23343  
 Max.   : 6.97464   Max.   :11.19492  
                    NA's   :1         </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>    Modelo      RMSE
12 Gau9000  5.365889
11 Gau8000  5.412357
10 Gau7000  5.566375
9  Gau6000  5.921648
4  Exp9000  6.173449
3  Exp8000  6.328520
2  Exp7000  6.552319
1  Exp6000  6.897060
8  Sph9000  8.299080
7  Sph8000 10.008588
6  Sph7000 13.385435
5  Sph6000 20.649943</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Linear Model of Coregionalization found. Good.
[using ordinary cokriging]</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-45-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  6.058   7.008  10.062  14.376  22.092  29.246 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="contaminacion_bog_files/figure-html/unnamed-chunk-45-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- # COKRIGING #### -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- df <- merge(PM10[,1:3], PM2_5[1:3], by = c("este", "norte"), all = TRUE) -->
<!-- colnames(df)[3:4] <- c("PM10", "PM2.5") -->
<!-- cor(df, use = "complete.obs") -->
<!-- summary(dist(df[,1:2])) -->
<!-- coordinates(df) <- ~este + norte -->
<!-- summary(df) -->
<!-- df_ok <- df[!is.na(df$PM2.5) & !is.na(df$PM10), ] -->
<!-- # Define modelo gstat para cada variable -->
<!-- g <- gstat(NULL, id = "PM10", formula = PM10 ~ 1, data = df_ok) -->
<!-- g <- gstat(g,    id = "PM2.5", formula = PM2.5 ~ 1, data = df_ok) -->
<!-- # Calcula los variogramas directos y cruzado -->
<!-- # v <- variogram(g, cutoff = 14000, width = 1000) -->
<!-- v <- variogram(g, cutoff=15707.75, width = 1208.288) -->
<!-- v_filtrado <- v[v$np >= 5, ] -->
<!-- plot(v_filtrado, main = "Variogramas cruzados PM2.5 y PM10") -->
<!-- #  -->
<!-- ``` -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- calcular_rmse_lmc <- function(ajuste_lmc, v_filtrado) { -->
<!--   modelo_PM10 <- ajuste_lmc$model$PM10 -->
<!--   modelo_PM25 <- ajuste_lmc$model$PM2.5 -->
<!--   modelo_cross <- ajuste_lmc$model$PM10.PM2.5 -->
<!--   v_PM10 <- subset(v_filtrado, id == "PM10") -->
<!--   v_PM25 <- subset(v_filtrado, id == "PM2.5") -->
<!--   v_cross <- subset(v_filtrado, id == "PM10.PM2.5") -->
<!--   pred_PM10 <- variogramLine(modelo_PM10, dist_vector = v_PM10$dist) -->
<!--   pred_PM25 <- variogramLine(modelo_PM25, dist_vector = v_PM25$dist) -->
<!--   pred_cross <- variogramLine(modelo_cross, dist_vector = v_cross$dist) -->
<!--   rmse_PM10 <- sqrt(mean((v_PM10$gamma - pred_PM10$gamma)^2)) -->
<!--   rmse_PM25 <- sqrt(mean((v_PM25$gamma - pred_PM25$gamma)^2)) -->
<!--   rmse_cross <- sqrt(mean((v_cross$gamma - pred_cross$gamma)^2)) -->
<!--   mean(c(rmse_PM10, rmse_PM25, rmse_cross)) -->
<!-- } -->
<!-- ajustar_y_evaluar_modelos <- function(v_filtrado, g, modelos_base) { -->
<!--   resultados <- data.frame(Modelo = character(), RMSE = numeric(), stringsAsFactors = FALSE) -->
<!--   for (nombre in names(modelos_base)) { -->
<!--     modelo_inicial <- modelos_base[[nombre]] -->
<!--     ajuste <- tryCatch({ -->
<!--       fit.lmc(v_filtrado, g, model = modelo_inicial) -->
<!--     }, error = function(e) NULL) -->
<!--     if (!is.null(ajuste)) { -->
<!--       rmse <- calcular_rmse_lmc(ajuste, v_filtrado) -->
<!--       resultados <- rbind(resultados, data.frame(Modelo = nombre, RMSE = rmse)) -->
<!--     } -->
<!--   } -->
<!--   resultados <- resultados[order(resultados$RMSE), ] -->
<!--   return(resultados) -->
<!-- } -->
<!-- # Define tus modelos base, por ejemplo: -->
<!-- modelos_base <- list( -->
<!--   Exp6000 = vgm(psill = 0.15, model = "Exp", nugget = 0.05, range = 6000), -->
<!--   Exp7000 = vgm(psill = 0.15, model = "Exp", nugget = 0.05, range = 7000), -->
<!--   Exp8000 = vgm(psill = 0.15, model = "Exp", nugget = 0.05, range = 8000), -->
<!--   Exp9000 = vgm(psill = 0.15, model = "Exp", nugget = 0.05, range = 9000), -->
<!--   Sph6000 = vgm(psill = 0.15, model = "Sph", nugget = 0.05, range = 6000), -->
<!--   Sph7000 = vgm(psill = 0.15, model = "Sph", nugget = 0.05, range = 7000), -->
<!--   Sph8000 = vgm(psill = 0.15, model = "Sph", nugget = 0.05, range = 8000), -->
<!--   Sph9000 = vgm(psill = 0.15, model = "Sph", nugget = 0.05, range = 9000), -->
<!--   Gau6000 = vgm(psill = 0.15, model = "Gau", nugget = 0.05, range = 6000), -->
<!--   Gau7000 = vgm(psill = 0.15, model = "Gau", nugget = 0.05, range = 7000), -->
<!--   Gau8000 = vgm(psill = 0.15, model = "Gau", nugget = 0.05, range = 8000), -->
<!--   Gau9000 = vgm(psill = 0.15, model = "Gau", nugget = 0.05, range = 9000) -->
<!-- ) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- # Corre la comparación: -->
<!-- resultados <- ajustar_y_evaluar_modelos(v_filtrado, g, modelos_base) -->
<!-- print(resultados) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- # Define el modelo con estructura esférica -->
<!-- model <- vgm(psill = 0.15, model = "Gau", nugget = 0.05, range = 5000) -->
<!-- # Ajusta el modelo a los tres variogramas -->
<!-- lmc <- fit.lmc(v_filtrado, g, model = model) -->
<!-- # Visualiza el ajuste -->
<!-- plot(v_filtrado, lmc, main = "Ajuste del modelo LMC") -->
<!-- ``` -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- # 0. Crear el objeto gstat con modelos ajustados desde LMC -->
<!-- g_cokrig <- gstat(NULL, id = "PM2.5", formula = PM2.5 ~ 1, data = df_ok, model = lmc$model$PM2.5) -->
<!-- g_cokrig <- gstat(g_cokrig, id = "PM10", formula = PM10 ~ 1, data = df_ok, model = lmc$model$PM10) -->
<!-- g_cokrig <- gstat(g_cokrig, id = c("PM2.5", "PM10"), model = lmc$model$PM10.PM2.5) -->
<!-- # 1. Crear grilla basada en el shapefile -->
<!-- bbox_colom <- st_bbox(colom_shp) -->
<!-- grilla <- expand.grid( -->
<!--   x = seq(bbox_colom["xmin"], bbox_colom["xmax"], by = 100), -->
<!--   y = seq(bbox_colom["ymin"], bbox_colom["ymax"], by = 100) -->
<!-- ) -->
<!-- #496980.4 -->
<!-- coordinates(grilla) <- ~x + y -->
<!-- gridded(grilla) <- TRUE -->
<!-- proj4string(grilla) <- CRS(st_crs(df_ok)$wkt)  # CRS consistente con los datos de entrenamiento -->
<!-- # 2. Predecir con cokriging (predicción y varianza) -->
<!-- pred <- predict(g_cokrig, newdata = grilla) -->
<!-- # 3. Limitar la predicción a [0, 1] -->
<!-- pred$PM2.5.pred[pred$PM2.5.pred < 0] <- 0 -->
<!-- pred$PM2.5.pred[pred$PM2.5.pred > 1] <- 1 -->
<!-- # 4. Convertir a raster y recortar al país (para predicción) -->
<!-- pred_raster <- raster(pred["PM2.5.pred"]) -->
<!-- colom_sp <- as(colom_shp, "Spatial") -->
<!-- pred_raster_masked <- mask(pred_raster, colom_sp) -->
<!-- # 5. Convertir a raster y recortar al país (para varianza) -->
<!-- var_raster <- raster(pred["PM2.5.var"])  # O el nombre correcto de la varianza en pred -->
<!-- var_raster_masked <- mask(var_raster, colom_sp) -->
<!-- # 6. Convertir a data.frame para ggplot -->
<!-- pred_df <- as.data.frame(pred_raster_masked, xy = TRUE) -->
<!-- pred_df <- na.omit(pred_df) -->
<!-- var_df <- as.data.frame(var_raster_masked, xy = TRUE) -->
<!-- var_df <- na.omit(var_df) -->
<!-- # 7. Visualizar la predicción puntual -->
<!-- p1 <- ggplot() + -->
<!--   geom_raster(data = pred_df, aes(x = x, y = y, fill = PM2.5.pred)) + -->
<!--   geom_sf(data = colom_shp, fill = NA, color = "black", linewidth = 0.3) + -->
<!--   scale_fill_gradientn( -->
<!--     name = "Probabilidad\nPM2.5 ≥ 25", -->
<!--     limits = c(0, 1), -->
<!--     colours = c("blue", "cyan", "green", "yellow", "orange", "red") -->
<!--   ) + -->
<!--   labs( -->
<!--     title = "Probabilidad estimada de PM2.5 ≥ 15 µg/m³", -->
<!--     subtitle = "Cokriging Indicador con PM10 como covariable", -->
<!--     caption = "Modelo Gaussiano ajustado con LMC" -->
<!--   ) + -->
<!--   theme_minimal() + -->
<!--   theme( -->
<!--     legend.position = "right", -->
<!--     axis.title = element_blank(), -->
<!--     plot.title = element_text(face = "bold", hjust = 0.5), -->
<!--     plot.subtitle = element_text(hjust = 0.5) -->
<!--   ) + -->
<!--   coord_sf() -->
<!-- # 8. Visualizar la varianza (incertidumbre) de la predicción -->
<!-- p2 <- ggplot() + -->
<!--   geom_raster(data = var_df, aes(x = x, y = y, fill = PM2.5.var)) + -->
<!--   geom_sf(data = colom_shp, fill = NA, color = "black", linewidth = 0.3) + -->
<!--   scale_fill_gradient( -->
<!--     name = "Varianza\nPM2.5", -->
<!--     low = "white", -->
<!--     high = "darkred", -->
<!--   ) + -->
<!--   labs( -->
<!--     title = "Varianza estimada de la predicción de PM2.5", -->
<!--     subtitle = "Indicador Cokriging", -->
<!--     caption = "Modelo Gaussiano ajustado con LMC" -->
<!--   ) + -->
<!--   theme_minimal() + -->
<!--   theme( -->
<!--     legend.position = "right", -->
<!--     axis.title = element_blank(), -->
<!--     plot.title = element_text(face = "bold", hjust = 0.5), -->
<!--     plot.subtitle = element_text(hjust = 0.5) -->
<!--   ) + -->
<!--   coord_sf() -->
<!-- # 9. Mostrar ambos gráficos (puedes elegir imprimir uno a la vez o usar gridExtra/patchwork para juntarlos) -->
<!-- print(p1) -->
<!-- print(p2) -->
<!-- summary(var_df$PM2.5.var) -->
<!-- ``` -->
<!-- ## **Análisis inicial de PM10** -->
<!-- Al igual que la variable PM2.5 se realizara el análisis descriptivo geoespacial para el periodo 2022 para el material particulado en el aire con un diámetro aerodinámico menor o igual a 10 micrómetros (PM10) del cual se dispone del promedio anual proveniente de 19 estaciones de monitoreo dispersas por la ciudad. -->
<!-- ```{r} -->
<!-- #| include: false -->
<!-- datos <- read.csv("calidad_aire.csv", header = T) -->
<!-- bogota <- datos %>%  -->
<!--   filter(Código.del.Departamento == 11) -->
<!-- PM10 <- bogota %>% -->
<!--   filter(Variable == "PM10") %>% -->
<!--   rename(ID = ID.Estacion, -->
<!--          Anio = Año) %>% -->
<!--   group_by(ID, Anio, Variable) %>% -->
<!--   mutate(Valor = row_number()) %>% -->
<!--   ungroup() %>% -->
<!--   pivot_wider(id_cols = c("ID", "Latitud", "Longitud", "Anio", "Valor"), -->
<!--               names_from = "Variable", -->
<!--               values_from = "Promedio") %>% -->
<!--   select(-Valor) -->
<!-- PM10_2022 <- PM10 %>% -->
<!--   filter(Anio == 2022) -->
<!-- # Pasándo a coordenadas proyectadas -->
<!-- coords_geo <- SpatialPoints(cbind(PM10_2022$Longitud,  -->
<!--                                   PM10_2022$Latitud), -->
<!--                             proj4string = CRS("+proj=longlat +datum=WGS84")) -->
<!-- data_aire_geo <- data.frame(coords_geo, PM10 = PM10_2022$PM10) -->
<!-- CRS_UTM_CO <- CRS("+proj=utm +zone=18 +datum=WGS84 +units=m +no_defs") -->
<!-- coords_utm <- spTransform(coords_geo, CRS_UTM_CO) -->
<!-- PM10_2022 <- data.frame(coords_utm, PM10 = PM10_2022$PM10) -->
<!-- PM10_2022 <- PM10_2022 %>% -->
<!--   rename( -->
<!--     Longitud = coords.x1, -->
<!--     Latitud = coords.x2 -->
<!--   ) -->
<!-- ``` -->
<!-- ### Visualización valores registrados -->
<!-- En la siguiente gráfica se observan los valores registrados por las estaciones de monitoreo para el periodo correspondiente, se observan que hay una mayor concentración de estaciones hacia la zona sur occidental de la ciudad y de igual forma en la zona mencionada se registraron los mayores registros (ilustrados por los puntos amarillos) de las partículas PM10 lo cual se puede estar vinculado a la presencia de zonas industriales en el sector de la Sevillana e igualmente al ser una de las entradas vehiculares de la ciudad -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- PM10_2022sf <- st_as_sf(PM10_2022,  -->
<!--                         coords = c("Longitud", "Latitud"), -->
<!--                         crs = CRS_UTM_CO) -->
<!-- ggplot(bogota_shp) + -->
<!--   geom_sf(fill = "lightgray", color = "black") + -->
<!--   geom_sf(data = PM10_2022sf, -->
<!--           aes(color = PM10, size = PM10), -->
<!--           alpha = 0.7, -->
<!--           show.legend = c(color = TRUE, size = FALSE)) + -->
<!-- scale_color_viridis_c(option = "plasma", name = "Valor") + -->
<!--   labs(title = "Partículas PM10 en Bogotá año 2022", -->
<!--        x = "Longitud", -->
<!--        y = "Latitud") + -->
<!--   theme_minimal() -->
<!-- ``` -->
<!-- ### Relación PM10 vs coordenadas espaciales -->
<!-- ```{r} -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- #| include: false -->
<!-- PM10_2022g <- as.geodata(PM10_2022, coords.col = 1:2, data.col = 4) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- plot.geodata(PM10_2022g) -->
<!-- ``` -->
<!-- En los gráficos donde se comparan los valores registrados de partículas PM10 y los ejes coordenados se observan que para la longitud hay un patrón decreciente, de igual forma se observa que posiblemente hay un valor atípico que puede influir en los análisis posteriores. En el caso de la relación de los registros y la latitud no se observa un patrón tan notorio como en el otro eje lo cual puede indicar que la latitud no influye tanto como lo que seria la longitud. -->
<!-- ### Ajuste modelo de regresión -->
<!-- Con el fin de extraer la tendencia del proceso espacial se ajustaron varios modelos de regresión del cual se concluyo que el modelo que tiene como único predictor a la longitud es el mas idóneo dado que comparado con los otros modelos contemplados es el mas parsimonio. Los modelos contemplados y sus resultados fueron los siguientes: -->
<!-- -   $PM10=Longitud + Latitud + [Longitud*Latitud] +\epsilon$ -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- summary(lm(PM10 ~ Longitud + Latitud + I(Longitud*Latitud), data = PM10_2022)) -->
<!-- ``` -->
<!-- -   $PM10=Longitud + Latitud +\epsilon$ -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- summary(lm(PM10 ~ Longitud + Latitud, data = PM10_2022)) -->
<!-- ``` -->
<!-- El modelo que fue seleccionado -->
<!-- $$ -->
<!-- PM10=Latitud + \epsilon -->
<!-- $$ -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- summary(lm(PM10 ~ Longitud, data = PM10_2022)) -->
<!-- # Es el modelo con mejor R^2 ajustado -->
<!-- lm_PM10 <- lm(PM10 ~ Longitud, data = PM10_2022) -->
<!-- PM10_2022$residuales <- lm_PM10$residuals -->
<!-- ``` -->
<!-- Aunque el primer modelo que contempla como variables explicativas tanto a la latitud como a la longitud y la iteracción entre estas presento un $R^2$ ajustado superior al de los otros modelos, se tiene que ninguna de las variables de son significativas por lo cual como se menciono anteriormente se opto por el modelo que contempla únicamente como variable explicativa a la longitud puesto que presento un $R^2$ ajustado cercano al del primer modelo y que se tiene que la variable es significativa. -->
<!-- ### Análisis de residuos -->
<!-- Después de haberse realizado el ajuste del modelo de tendencia, se observa que los residuos estandarizados no presentan un patrón definido, lo cual indica que el modelo de regresión seleccionado en efecto capturo la tendencia del proceso. -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- par(mfrow = c(1, 3)) -->
<!-- # Residuales estandarizados vs Coordenada Este -->
<!-- plot(PM10_2022$Longitud, rstandard(lm_PM10), -->
<!--      main = "Residuales vs Longitud", -->
<!--      xlab = "Longitud", -->
<!--      ylab = "Residuales estandarizados", -->
<!--      pch = 16, col = "darkblue") -->
<!-- # Residuales estandarizados vs Coordenada Norte -->
<!-- plot(PM10_2022$Latitud, rstandard(lm_PM10), -->
<!--      main = "Residuales vs Latitud", -->
<!--      xlab = "Latitud", -->
<!--      ylab = "Residuales estandarizados", -->
<!--      pch = 16, col = "darkgreen") -->
<!-- # Boxplot de los residuales estandarizados -->
<!-- boxplot(rstandard(lm_PM10), -->
<!--         main = "Distribución de Residuales", -->
<!--         ylab = "Residuales estandarizados", -->
<!--         col = "red", -->
<!--         ylim = c(-2, 3)) -->
<!-- par(mfrow = c(1, 1)) -->
<!-- ``` -->
<!-- Aunque en el boxplot se observa que no hay presencia de datos atípicos, en los gráficos de los residuales estandarizados vs cada uno de los ejes se señala la presencia de un valor que se aleja significativamente del comportamiento del restante de valores lo cual coincide con lo observado anteriormente en los gráficos de las partículas PM10 por lo tanto se decide que se hará uso de estimadores robustos con el fin disminuir la posible influencia de dicho valor en los análisis posteriores. -->
<!-- ### Visualización espacial de residuos -->
<!-- A continuación se gráfican los residuos en el espacio, en donde a diferencia de los valores PM10 no hay presencia de clusters notorios y de igual forma se removió la tendencia originalmente presenciada puesto que los residuos varían al rededor de 0 en ambos ejes espaciales. -->
<!-- ```{r} -->
<!-- #| include: false -->
<!-- # Datos centrados  -->
<!-- PM10_2022resg <- as.geodata(PM10_2022, coords.col = 1:2, data.col = 5) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- plot.geodata(PM10_2022resg, scatter3d = TRUE) -->
<!-- ``` -->
<!-- ### Estimación del semivariograma y uso de un estimador robusto -->
<!-- Se realizara la estimación del semivariograma empírico de los residuos con el fin de analizar la dependencia espacial de dichos valores. -->
<!-- ```{r} -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- #| include: false -->
<!-- variPM10_2022 <- variog(PM10_2022resg, estimator.type = "modulus") -->
<!-- ``` -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- #| message: false -->
<!-- #| warning: false -->
<!-- #| fig-cap: "Variograma clasico y robusto de los residuales de PM10" -->
<!-- # Variograma PM10 -->
<!-- par(mfrow = c(1, 2)) -->
<!-- plot(variog(PM10_2022resg)) -->
<!-- plot(variog(PM10_2022resg, estimator.type = "modulus")) -->
<!-- ``` -->
<!-- Aunque como se menciono anteriormente sobre el uso de estimadores robustos se presenta a la izquierda el semivariograma estimado usando el estimador clasico, a la derecha se presenta el semivariograma estimado usando el estimador robusto definido como: -->
<!-- $$ -->
<!-- \tilde{\gamma}(\mathbf{h}) = \frac{1}{2 \left( 0.457 + \frac{0.494}{|N(\mathbf{h})|} + \frac{0.045}{|N^2(\mathbf{h})|} \right)} \left( \frac{\left( \sum_{N(\mathbf{h})} |Z(\mathbf{s} + \mathbf{h}) - Z(\mathbf{s})|^{1/2} \right)^4}{|N(\mathbf{h})|} \right) -->
<!-- $$ -->
<!-- El cual corresponde al estimador resistente a datos atípicos utilizando el promedio, propuesto por Cressie. -->
<!-- ### Ajuste de modelos teóricos al semivariograma empírico -->
<!-- Haciendo uso de la función eyefit del paquete geoR se concluyo visualmente que los tres modelos que se ajustaban al modelo empírico fueron el modelo exponencial, el esférico y el gaussiano -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- # Ajuste por eyefit -->
<!-- expPM10_2022 <- variofit(variPM10_2022, -->
<!--                     cov.model = "exponential", -->
<!--                     ini = c(55, 15000), -->
<!--                     fix.nugget = TRUE, -->
<!--                     nugget = 1, -->
<!--                     weights = "cressie") -->
<!-- sphPM10_2022 <- variofit(variPM10_2022, -->
<!--                          cov.model = "spherical", -->
<!--                          ini = c(40, 5000), -->
<!--                          fix.nugget = TRUE, -->
<!--                          nugget = 10, -->
<!--                          weights = "cressie") -->
<!-- gauPM10_2022 <- variofit(variPM10_2022, -->
<!--                          cov.model = "gaussian", -->
<!--                          ini = c(45, 9000), -->
<!--                          fix.nugget = TRUE, -->
<!--                          nugget = 0, -->
<!--                          weights = "cressie") -->
<!-- ``` -->
<!-- Los tres modelos sugeridos se ajustaron con efecto pepita libre fijo. A continuación se muestran los tres modelos propuestos superpuestos al semivariograma empírico -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- plot(variPM10_2022$u, variPM10_2022$v, -->
<!--      xlab = "Distancia (h)", -->
<!--      ylab = "Semivarianza", -->
<!--      cex.lab = 1.3, -->
<!--      cex.axis = 1.2, -->
<!--      main = "Ajuste de Modelos Teóricos al Semivariograma Empírico", -->
<!--      col.main = 4, -->
<!--      cex.main = 1.3, -->
<!--      pch = 20) -->
<!-- lines(expPM10_2022, col = "blue", lwd = 2, lty = 1) -->
<!-- lines(sphPM10_2022, col = "red", lwd = 2, lty = 2) -->
<!-- lines(gauPM10_2022, col = "purple", lwd = 2, lty = 3) -->
<!-- legend("topright", -->
<!--        legend = c("Exponencial", "Esferico", "Gaussiano"), -->
<!--        col = c("blue", "red", "purple"), -->
<!--        lty = 1:3, -->
<!--        lwd = 2, -->
<!--        bty = "n", -->
<!--        text.col = "black") -->
<!-- ``` -->
<!-- Se observa que los tres modelos se pueden estar viendo influenciados posiblemente por los valores significativamente altos que se encuentra en los primeros lags. Siendo el gaussiano el que menos se ve influenciado visualmente. -->
<!-- Con el fin de elegir el mejor modelo de los tres sugeridos se hace uso del RMSE para cada uno, dando como resultado los siguientes valores: -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- # Calcular RMSE para cada ajuste -->
<!-- rmse1 <- calc_rmse(variPM10_2022, expPM10_2022) -->
<!-- rmse2 <- calc_rmse(variPM10_2022, sphPM10_2022) -->
<!-- rmse3 <- calc_rmse(variPM10_2022, gauPM10_2022) -->
<!-- # Mostrar resultados -->
<!-- rmse_comparacion <- c(Exponencial = rmse1, Esferico = rmse2, Gaussiano = rmse3) -->
<!-- knitr::kable(rmse_comparacion, col.names = c("Modelo", "RMSE")) -->
<!-- ``` -->
<!-- Dado que el modelo exponencial es el modelos que presenta el menor RSME se selecciona dicho modelo. -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- plot(variPM10_2022$u, variPM10_2022$v, -->
<!--      xlab = "Distancia (h)", -->
<!--      ylab = "Semivarianza", -->
<!--      cex.lab = 1.3, -->
<!--      cex.axis = 1.2, -->
<!--      main = "Ajuste de Modelos exponencial -->
<!--      al Semivariograma Empírico", -->
<!--      col.main = 4, -->
<!--      cex.main = 1.3, -->
<!--      pch = 20) -->
<!-- lines(expPM10_2022, col = "blue", lwd = 2, lty = 1) -->
<!-- legend("topright", -->
<!--        legend = "Exponencial", -->
<!--        col = "blue", -->
<!--        lty = 1, -->
<!--        lwd = 2, -->
<!--        bty = "n", -->
<!--        text.col = "black") -->
<!-- ``` -->
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>